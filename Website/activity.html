<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity - SecureShare</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="bg-gradient-1"></div>
        <div class="bg-gradient-2"></div>
        <div class="bg-gradient-3"></div>
    </div>

    <header class="dashboard-header">
        <nav class="dashboard-nav">
            <div class="dashboard-nav-left">
                <div class="logo-section">
                    <div class="logo-icon">
                        <svg class="shield-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2L4 5v6c0 5.55 3.84 10.74 8 12 4.16-1.26 8-6.45 8-12V5l-8-3z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="logo-text">SecureShare</div>
                        <div style="font-size: 12px; color: #666;">Enterprise File Sharing & DLP</div>
                    </div>
                </div>
            </div>
            <div class="dashboard-nav-center">
                <a href="dashboard.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="files.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>Files</span>
                </a>
                <a href="upload.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <span>Upload</span>
                </a>
                <a href="activity.html" class="nav-item active">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                    <span>Activity</span>
                </a>
            </div>
            <div class="dashboard-nav-right">
                <div class="notification-bell" id="notificationBell">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span class="notification-dot" id="notificationDot" style="display: none;"></span>
                </div>
                <a href="settings.html" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                    </svg>
                    <span>Settings</span>
                </a>
                <a href="upload.html" class="quick-action-btn header-btn" id="upload-btn-header" style="display: none;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <span>Upload File</span>
                </a>
                <a href="files.html" class="quick-action-btn header-btn header-btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>View Files</span>
                </a>
                <a href="index.html" class="nav-item logout-item" id="logoutBtn">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    <span>Logout</span>
                </a>
            </div>
        </nav>
    </header>

    <main class="dashboard-content">
        <h1 class="page-title">Activity Log</h1>
        <p class="page-subtitle">Monitor all file access and security events</p>

        <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 16px; margin-bottom: 24px;">
            <div class="select-wrapper">
                <select id="riskLevelFilter">
                    <option value="all">All Risk Levels</option>
                    <option value="low">Low Risk</option>
                    <option value="medium">Medium Risk</option>
                    <option value="high">High Risk</option>
                </select>
            </div>
            <div class="select-wrapper">
                <select id="actionTypeFilter">
                    <option value="all">All Actions</option>
                    <option value="download">Download</option>
                    <option value="view">View</option>
                    <option value="upload">Upload</option>
                    <option value="share">Share</option>
                </select>
            </div>
            <div class="input-wrapper">
                <input type="text" id="searchInput" placeholder="Search files or users..." style="padding-left: 40px;">
                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
            </div>
        </div>

        <div class="metrics-grid" style="margin-bottom: 30px;">
            <div class="metric-card modern-metric">
                <div class="metric-value" id="downloadsCount" style="color: #065f46;">0</div>
                <div class="metric-label">Downloads</div>
            </div>
            <div class="metric-card modern-metric">
                <div class="metric-value" id="accessDeniedCount" style="color: #991b1b;">0</div>
                <div class="metric-label">Access Denied</div>
            </div>
            <div class="metric-card modern-metric">
                <div class="metric-value" id="highRiskCount" style="color: #991b1b;">0</div>
                <div class="metric-label">High Risk</div>
            </div>
            <div class="metric-card modern-metric">
                <div class="metric-value" id="totalEventsCount">0</div>
                <div class="metric-label">Total Events</div>
            </div>
        </div>

        <div class="card modern-card">
            <div class="card-header">
                <h3 class="card-title">Recent Activity</h3>
                <p style="color: #666; font-size: 14px;" id="eventsCount">Loading...</p>
            </div>

            <div id="activityContainer">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Loading activity logs...</p>
                </div>
            </div>
        </div>
    </main>
    <script src="js/script.js"></script>
    <script>
        // Activity page specific functionality
        let activityFilters = {
            riskLevel: 'all',
            actionType: 'all',
            search: ''
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            checkAuthentication();
            
            // Setup logout
            setupLogout();
            
            // Load activity logs
            loadActivityLogs();
            
            // Setup filters
            setupFilters();
            
            // Auto-refresh every 30 seconds
            setInterval(loadActivityLogs, 30000);
        });

        // Check if user is authenticated
        function checkAuthentication() {
            const token = sessionStorage.getItem('user_token') || 
                         sessionStorage.getItem('auth_token') || 
                         sessionStorage.getItem('userToken') ||
                         localStorage.getItem('user_token') || 
                         localStorage.getItem('auth_token') ||
                         localStorage.getItem('userToken');
            
            if (!token) {
                sessionStorage.setItem('redirectAfterLogin', 'activity.html');
                window.location.href = 'login.html';
                return;
            }
        }

        // Setup logout functionality
        function setupLogout() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    if (confirm('Are you sure you want to logout?')) {
                        try {
                            const token = sessionStorage.getItem('user_token') || 
                                         sessionStorage.getItem('auth_token') || 
                                         sessionStorage.getItem('userToken');
                            
                            if (token) {
                                const formData = new FormData();
                                formData.append('action', 'logout');
                                formData.append('token', token);
                                await fetch('api.php', { method: 'POST', body: formData });
                            }
                        } catch (error) {
                            console.error('Logout error:', error);
                        } finally {
                            sessionStorage.clear();
                            localStorage.clear();
                            window.location.href = 'login.html';
                        }
                    }
                });
            }
        }

        // Setup filters
        function setupFilters() {
            const riskFilter = document.getElementById('riskLevelFilter');
            const actionFilter = document.getElementById('actionTypeFilter');
            const searchInput = document.getElementById('searchInput');

            if (riskFilter) {
                riskFilter.addEventListener('change', function() {
                    activityFilters.riskLevel = this.value;
                    loadActivityLogs();
                });
            }

            if (actionFilter) {
                actionFilter.addEventListener('change', function() {
                    activityFilters.actionType = this.value;
                    loadActivityLogs();
                });
            }

            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        activityFilters.search = this.value.trim();
                        loadActivityLogs();
                    }, 500);
                });
            }
        }

        // Load activity logs
        async function loadActivityLogs() {
            try {
                const token = sessionStorage.getItem('user_token') || 
                             sessionStorage.getItem('auth_token') || 
                             sessionStorage.getItem('userToken') ||
                             localStorage.getItem('user_token') || 
                             localStorage.getItem('auth_token') ||
                             localStorage.getItem('userToken');

                if (!token) {
                    return;
                }

                const formData = new FormData();
                formData.append('action', 'get_activity_logs');
                formData.append('token', token);
                formData.append('risk_level', activityFilters.riskLevel);
                formData.append('action_type', activityFilters.actionType);
                formData.append('search', activityFilters.search);
                formData.append('limit', '50');

                const response = await fetch('api.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                const container = document.getElementById('activityContainer');

                if (data.success && data.logs) {
                    // Update statistics
                    if (data.stats) {
                        document.getElementById('downloadsCount').textContent = data.stats.downloads || 0;
                        document.getElementById('accessDeniedCount').textContent = data.stats.access_denied || 0;
                        document.getElementById('highRiskCount').textContent = data.stats.high_risk || 0;
                        document.getElementById('totalEventsCount').textContent = data.stats.total_events || 0;
                    }

                    // Update events count
                    const eventsCountEl = document.getElementById('eventsCount');
                    if (eventsCountEl) {
                        eventsCountEl.textContent = `${data.logs.length} event${data.logs.length !== 1 ? 's' : ''} found`;
                    }

                    // Render activity logs
                    if (data.logs.length > 0) {
                        container.innerHTML = data.logs.map(log => renderActivityItem(log)).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state">No activity logs found</div>';
                    }
                } else {
                    container.innerHTML = '<div class="empty-state">Error loading activity logs</div>';
                }
            } catch (error) {
                console.error('Error loading activity logs:', error);
                const container = document.getElementById('activityContainer');
                if (container) {
                    container.innerHTML = '<div class="empty-state">Error loading activity logs</div>';
                }
            }
        }

        // Render activity item
        function renderActivityItem(log) {
            const riskClass = `risk-${log.risk_level}`;
            const date = new Date(log.created_at);
            const formattedDate = formatDate(date);
            
            // Get action description
            let actionDesc = log.action || log.event_type;
            if (log.user_email) {
                actionDesc = `${actionDesc} by ${log.user_email}`;
            }

            // Get action icon SVG
            const actionIcon = getActionIcon(log.action_icon, log.risk_level === 'high' && !log.success);

            // Build warning message if access denied
            let warningHtml = '';
            if (!log.success || log.risk_level === 'high') {
                warningHtml = `
                    <div style="background: #fee2e2; padding: 8px; border-radius: 6px; font-size: 12px; color: #991b1b; display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        ${log.description || 'Unauthorized access attempt blocked'}
                    </div>
                `;
            }

            return `
                <div class="activity-item">
                    <span class="risk-badge ${riskClass}">${log.risk_level} risk</span>
                    <div class="activity-details">
                        <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(log.file_name)}</div>
                        <div style="color: ${log.risk_level === 'high' ? '#991b1b' : '#666'}; font-size: 14px; margin-bottom: ${warningHtml ? '8px' : '0'};">
                            ${escapeHtml(actionDesc)}
                        </div>
                        ${warningHtml}
                        <div class="activity-location" style="margin-top: ${warningHtml ? '8px' : '0'};">
                            IP: ${log.ip_address} â€¢ ${formattedDate}
                        </div>
                    </div>
                    ${actionIcon}
                </div>
            `;
        }

        // Get action icon SVG
        function getActionIcon(iconType, isError) {
            const color = isError ? '#991b1b' : 'currentColor';
            const strokeWidth = isError ? '2.5' : '2';

            const icons = {
                download: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="${strokeWidth}">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>`,
                view: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="${strokeWidth}">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>`,
                upload: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="${strokeWidth}">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>`,
                share: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="${strokeWidth}">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>`,
                warning: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="${strokeWidth}">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>`
            };

            return icons[iconType] || icons.download;
        }

        // Format date
        function formatDate(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
